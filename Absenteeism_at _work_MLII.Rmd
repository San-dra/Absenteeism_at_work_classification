---
title: "Predicting Absenteeism at work"
subtitle: "Machine Learning II"
author: "Sandra Alemayehu & Jessica Hayek"
date: "21 February 2020"
output:
  rmarkdown::html_document:
    code_folding: show
    df_print: paged
    fig_caption: yes
    theme: lumen
    toc: yes
    toc_float: yes

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(prettydoc) #For rmd theme
library(MASS)
library(ISLR)
library(rpart)
library(rpart.plot)
library(randomForest)
library(ggplot2)
library(e1071)     
library(glmnet)
library(caret)     
library(FSelector)
library(dplyr)
library(knitr)
library(magrittr)
library(lattice)
library(skimr)
```

# Introduction
The main goal is to **predict whether or not an individual is going to have a long absence** (`Absenteeism` variable) it's therefore a binary classification problem.

# Data Loading and Overview


```{r Loading Training}

abs_training_df<-read.csv("C:/Users/sandr/Desktop/Machine Learning II/ML Assignment/Absenteeism_at_work_classification/Absenteeism_at_work_classification_training.csv",sep = ";")
ncol(abs_training_df)

abs_test_df = read.csv(file = file.path("C:/Users/sandr/Desktop/Machine Learning II/ML Assignment/Absenteeism_at_work_classification/Absenteeism_at_work_classification_test.csv"),  header = TRUE, dec = ".", sep = ";")
```

## Variable Type
```{r Variables}
data.frame(Variable = names(abs_training_df),
           Class = sapply(abs_training_df, typeof),
           First_values = sapply(abs_training_df, function(x) paste0(head(x),  collapse = ", ")),
           row.names = NULL) %>% kable()
```

The dataframe contains **22** variables.The target variable is **Absenteeism**, a logical variable setting categorizing whether an individual is going to be absent more than 5 hours in total.

## Data overview

```{r Training Dataset Overview, echo=FALSE}
skim(abs_training_df)
```

# Data Cleaning and Preparation
From the data overview we can identify there target variable is sufficiently balanced in training set with 63% False and 47% True. We also dont have any missing values.
However we do have variable which are codified as numbers which are supposed to be categorical and possible outliers in few variables such as age and transportation cost.

## Changing Data Type
We can see from the attribute information (https://archive.ics.uci.edu/ml/datasets/Absenteeism+at+work) that 11 categorical variables have been codified as number in our dataframe. These variables are: **ID**, **ID.Worker**, **Reason.for.absence**, **Month.of.absence**, **Day.of.the.week**, **Seasons**, **Disciplinary.failure**, **Education**, **Social.drinker**, **Social.smoker**,**Absenteeism** 
Before converting these these variables need to combine test dataset with train dataset, and apply the conversion on both. 

```{r Combine Dataset, echo=FALSE}
abs_test_df$Absenteeism <- 0  #add taget variable Absenteeism into the test dataset
abs_dataset <- rbind(abs_training_df, abs_test_df)
str(abs_dataset) #check dataset
```
We can now convert all the categorical variables to factors. 
```{r Converting Variables, echo=FALSE}
categorical_variables <- c('ID', 'ID.Worker','Education','Reason.for.absence', 'Month.of.absence', 'Day.of.the.week', 'Seasons', 'Disciplinary.failure', 'Social.drinker', 'Social.smoker', 'Absenteeism')
abs_dataset[categorical_variables] <- lapply(abs_dataset[categorical_variables], factor) 
str(abs_dataset)
```

To make attributes more discriptive we will add the actual category names of variables **Education**, **Seasons**, and **Reason for Absence**. 
```{r Making Categorical Variables Discriptive}
abs_dataset$Reason.for.absence <- recode(abs_dataset$Reason.for.absence, 
                                     '0'='Infectious parasitic diseases',
                                     '1'='Neoplasms',
                                     '2'='Diseases of the blood',
                                     '3'='Endocrine and metabolic diseases',
                                     '4'='Mental and behavioural disorders',
                                     '5'='Diseases of the nervous system',
                                     '6'='Diseases of the eye and adnexa',
                                     '7'='Diseases of the ear and mastoid process',
                                     '8'='Diseases of the circulatory system',
                                     '9'='Diseases of the respiratory system',
                                     '10'='Diseases of the digestive system',
                                     '11'='Diseases of the skin and subcutaneous tissue',
                                     '12'='Diseases of the musculoskeletal system and connective tissue', 
                                     '13'='Diseases of the genitourinary system',
                                     '14'='Pregnancy, childbirth and the puerperium',
                                     '15'='Certain conditions originating in the perinatal',
                                     '16'='Congenital malformations, deformations and chromosomal abnormalities',
                                     '17'='Symptoms, signs and abnormal clinical  findings',
                                     '18'='Injury, poisoning and certain other consequences of external causes',
                                     '19'='causes of morbidity and mortality',
                                     '21'='Factors influencing health status and contact with health services',
                                     '22'='patient follow-up',
                                     '23'='medical consultation',
                                     '24'='blood donation',
                                     '25'='laboratory examination',
                                     '26'='unjustified absence',
                                     '27'='physiotherapy',
                                     '28'='dental consultation')

abs_dataset$Seasons =recode(abs_dataset$Seasons,'1'='summer','2'='autumn','3'='winter','4'='spring')

abs_dataset$Education =recode(abs_dataset$Education, '1'='highschool','2'='graduate','3'='postgraduate','4'='master&PhD')

#Check dataset again
str(abs_dataset$Seasons)
str(abs_dataset$Education)
str(abs_dataset$Reason.for.absence)
str(abs_dataset$Absenteeism)
```
The target variable already has One Hot Encoding and we dont need to make further changes to it. 

We are now done with changing variable types, and we can update our training and test dataset according to these changes and have them separetly for the net steps. 
```{r Making Train and Test Separate Again}
abs_training_df<-abs_dataset[1:593,]
abs_test_df<-abs_dataset[594:740,]
abs_test_df$Absenteeism<-NULL  #Removing the target Variable
```

## Check for Duplicate Observations
Our unique identifier in the dataset is the **ID** variable and we can use that to see if we have variables that have been duplicated. 
```{r Duplicates}
print(paste0("The total number of duplicates in our dataframe is: ", sum(duplicated(abs_training_df$ID))))
```

## Outlier Detection

We need to further prepare out dataset by checking for outliers in the numerical variables and identify if it is an error or an actual observation and decide how to move forward with these observations. 
```{r Boxplot}
par(mfrow=c(1,5))
boxplot(abs_training_df$Transportation.expense,
main = "Transp. Expense",
xlab = "Cost",
ylab = "Amount",
col = "orange",
border = "brown",
horizontal = FALSE,
notch = TRUE
)
boxplot(abs_training_df$Distance.from.Residence.to.Work,
main = "Dist. Resi.-Work",
xlab = "Distance",
ylab = "KMs",
col = "orange",
border = "brown",
horizontal = FALSE,
notch = TRUE
)
boxplot(abs_training_df$Service.time,
main = "Service Time",
xlab = "Serv. Time",
ylab = "Years",
col = "orange",
border = "brown",
horizontal = FALSE,
notch = TRUE
)
boxplot(abs_training_df$Age,
main = "Age",
xlab = "Age",
ylab = "Years",
col = "orange",
border = "brown",
horizontal = FALSE,
notch = TRUE
)

```


# Correlation


